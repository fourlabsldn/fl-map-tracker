<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Golden Eagle Tracking</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{
      display: flex;
      flex-flow: column nowrap;
      width: 100vw;
      height: 100vh;
      background-color: f0f0f0;
      text-align: center;
    }

    #map {
      width: 500px;
      height: 500px;
      margin: 0 auto;
      box-shadow: 0 0 20px #999;
    }
  </style>

  <!-- RequireJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js"></script>
  <script type="text/javascript">
    requirejs.config({
      baseUrl: './',
      paths: {
        'lodash/fp': 'https://cdnjs.cloudflare.com/ajax/libs/lodash-fp/0.10.4/lodash-fp.min',
        'fl-google-maps-driver': './lib/fl-google-maps-driver',
        'fl-map-tracker': '../dest/index'
      },
    });
  </script>
</head>
<body>
  <h1>Golden Eagle Tracking</h1>
  <div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCKdTnpxORlxfcVsuASHCeozz1CCMLM0u4"></script>
<script>
    function getNewCoordinates() {
      return fetch('http://localhost:8080/routes', {mode: 'cors'}).then(r => r.json())
    }


  require(
    ['fl-google-maps-driver', 'fl-map-tracker', 'lodash/fp'],
    function (MapDriver, mapTracker, _) {
      // Create map
      mapDriver = new MapDriver(google, '#map', { center: { lat: 51.473663, lng: -0.203287 }, zoom: 15});
      let points = [];

      setInterval(() => {
        getNewCoordinates()
        .then(_.get('points'))
        .then(mapTracker.comparePoints(points))
        .then(function ({ pointsToMove, pointsToCreate, pointsToDelete }) {
          // move markers
          pointsToMove.forEach(p => mapDriver.moveMarker(p.marker, p.location));

          const newPoints = pointsToCreate.map(mapTracker.addMarker(mapDriver)) // add marker to point
          points = points.concat(newPoints);

          pointsToDelete.forEach(p => {
            points = mapTracker.withoutPoint(mapDriver, points);
          });
        });
      }, 2000);
    }
  );
</script>
</body>
</html>
